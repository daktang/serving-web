<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="theme-color" content="#000000" />
  <link rel="icon" type="image/png" id="fevicon" href="images/icons/favicon.png" sizes="32x32">

  <!-- 0) 페이지 로드 전에 SW 등록: portal → localhost 강제 라우팅 -->
  <script>
  (function () {
    if (!('serviceWorker' in navigator)) return;

    // Service Worker 소스코드 (Blob으로 인라인 등록)
    var SW = `
self.addEventListener('install', e => self.skipWaiting());
self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));

const HOSTS = ['portal.aiserving.dev.aip.domain.net'];
// /net/ 오탈자도 흡수해 / 로 통일
const PREFIX = /^(api|coreproxy|ext-dit\\/api|models|serving|authservice)\\//i;

function rewrite(urlStr) {
  try {
    const u = new URL(urlStr);
    // 예: https://portal.../net/api/... → /api/...
    if (HOSTS.includes(u.hostname)) {
      let path = u.pathname.replace(/^\\/net\\//, '/'); // '/net/' 제거
      if (path.startsWith('/')) path = path.slice(1);
      if (PREFIX.test(path)) {
        return new URL('/' + path + u.search, self.location.origin).href;
      }
    }
  } catch {}
  return null;
}

self.addEventListener('fetch', (event) => {
  const req = event.request;

  // navigation/XHR/fetch/이미지 등 모두 커버
  const target = rewrite(req.url);
  if (!target) return; // 로컬로 강제할 대상 아님 → 그대로 통과

  // 원 요청을 보존해 같은 메서드/헤더/바디로 로컬에 재전송
  const newReq = new Request(target, req);

  event.respondWith(fetch(newReq));
});
    `;

    const blob = new Blob([SW], { type: 'text/javascript' });
    const url  = URL.createObjectURL(blob);

    navigator.serviceWorker.register(url, { scope: '/' }).then(() => {
      // 최초 1회만 리로드해서 SW가 즉시 페이지를 제어하도록
      if (!sessionStorage.getItem('sw_ready')) {
        sessionStorage.setItem('sw_ready', '1');
        location.reload();
      }
    }).catch(() => {});
  })();
  </script>

  <!-- 기존 순서 유지 -->
  <script src="config.js"></script>
  <script src="//code.jquery.com/jquery-1.4.2.min.js"></script>
  <script src="//cdn.socket.io/4.4.1/socket.io.min.js"></script>

  <script>document.title = window.config.applicationTitle || window.config.applicationName;</script>
</head>
<body>
  <noscript>You need to enable JavaScript to run this app.</noscript>
  <div id="root" class="grip-resizable"></div>
</body>
</html>
